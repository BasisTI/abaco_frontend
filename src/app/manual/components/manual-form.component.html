<div class="ui-g ui-fluid">
    <div class="ui-g-12">
        <div class="card card-w-title">
            <h1>{{ manual.id ? ('Cadastros.Manual.EditarManual' | translate) : ('Cadastros.Manual.CadastrarManual' | translate) }}
            </h1>

            <form name="editForm" (ngSubmit)="save()" #editForm="ngForm">
                <div class="ui-g-6 ui-md-6 ui-sm-6 form-fields-container">
                    <span class="md-inputfield">
                        <input name="nome" maxlength="250" [(ngModel)]="manual.nome" pInputText required />
                        <label for="nome" translate="Cadastros.Manual.Nome*">Nome *</label>
                        <div *ngIf="editForm.controls['nome']
                              && !editForm.controls['nome'].valid
                              && (editForm.controls['nome'].touched
                              || editForm.submitted)" class="ui-message ui-messages-error"
                            translate="Global.Mensagens.CampoObrigatorio">
                            Campo obrigatório.
                        </div>
                    </span>
                </div>

                <div class="ui-g-3 ui-md-3 ui-sm-3 form-fields-container">
                    <span class="md-inputfield">
                        <p-spinner required step="0.010" maxlength="5" name="valorVariacaoEstimada"
                            [(ngModel)]="manual.valorVariacaoEstimada">
                        </p-spinner>
                        <label for="valorVariacaoEstimada" translate="Cadastros.Manual.ValorEstimada">Valor Variação
                            Estimada (%) *</label>
                        <div *ngIf="editForm.controls['valorVariacaoEstimada']
                                        && !editForm.controls['valorVariacaoEstimada'].valid
                                        && (editForm.controls['valorVariacaoEstimada'].touched
                                        || editForm.submitted)" class="ui-message ui-messages-error"
                            translate="Global.Mensagens.CampoObrigatorio">
                            Campo obrigatório.
                        </div>
                    </span>
                </div>

                <div class="ui-g-3 ui-md-3 ui-sm-3 form-fields-container">
                    <span class="md-inputfield">
                        <p-spinner required step="0.010" maxlength="5" id="idValorVariacaoIndicativoFormManual"
                            name="valorVariacaoIndicativa" #valorVariacaoIndicativa='ngModel'
                            [(ngModel)]="manual.valorVariacaoIndicativa"></p-spinner>
                        <label translate="Cadastros.Manual.ValorIndicativa">Valor Variação Indicativa (%)
                            *</label>
                        <div *ngIf="editForm.controls['valorVariacaoIndicativa']
                                        && !editForm.controls['valorVariacaoIndicativa'].valid
                                        && (editForm.controls['valorVariacaoIndicativa'].touched
                                        || editForm.submitted)" class="ui-message ui-messages-error"
                            translate="Global.Mensagens.CampoObrigatorio">
                            Campo obrigatório.
                        </div>
                    </span>
                </div>


                <div class="ui-g-12 ui-md-12 ui-sm-12 form-fields-container">
                    <label translate="Cadastros.Manual.Observacao">Observação</label>
                    <textarea pInputTextarea name="descricao" maxlength="4000" [rows]="5" [cols]="180"
                        [(ngModel)]="manual.observacao">
                    </textarea>
                </div>

                <div class="ui-g-12 ui-md-12 ui-sm-12 form-fields-container">
                    <label for="arquivoManual" translate="Cadastros.Manual.ArquivoManual">Arquivo Manual</label>
                    <span class="md-inputfield">
                        <p-fileUpload #fileInput [chooseLabel]="'Cadastros.Manual.SelecionarArquivo' | translate"
                            [showUploadButton]="false" name="arquivoManual" [showCancelButton]="false"
                            name="arquivoManual" (onSelect)="uploadFile($event)" accept=".pdf,.odt,.doc,.docx">
                            <ng-template pTemplate="content">
                                <ul *ngIf="arquivoManual && !newUpload">
                                    <a target="_self" href="/api/downloadFile/{{ arquivoManual.id }}"
                                        download="arquivo-manual.pdf">{{arquivoManual.originalName}}</a>
                                </ul>
                            </ng-template>
                        </p-fileUpload>
                    </span>
                </div>

                <div class="ui-g-12 ui-md-12 ui-sm-12 form-fields-container">
                    <div class="ui-g">
                        <h2 translate="Cadastros.Manual.Impacto">Impacto</h2>
                    </div>

                    <div class="ui-g-3 ui-md-3 ui-sm-3 form-fields-container">
                        <span class="md-inputfield">
                            <p-spinner required [min]="0" [max]="100" [step]="0.010" name="parametroInclusao"
                                maxlength="5" name="parametroInclusao" [(ngModel)]="manual.parametroInclusao" required>
                            </p-spinner>
                            <label for="parametroInclusao" translate="Cadastros.Manual.Inclusao(%)*">Inclusão (%)
                                *</label>
                            <div *ngIf="editForm.controls['parametroInclusao']
                                            && !editForm.controls['parametroInclusao'].valid
                                            && (editForm.controls['parametroInclusao'].touched
                                            || editForm.submitted)" class="ui-message ui-messages-error"
                                translate="Global.Mensagens.CampoObrigatorio">
                                Campo obrigatório.
                            </div>
                        </span>
                    </div>

                    <div class="ui-g-3 ui-md-3 ui-sm-3 form-fields-container">
                        <span class="md-inputfield">
                            <p-spinner required [min]="0" [max]="100" step="0.010" name="parametroAlteracao"
                                maxlength="5" [(ngModel)]="manual.parametroAlteracao">
                            </p-spinner>
                            <label for="parametroAlteracao" translate="Cadastros.Manual.Alteracao(%)*">Alteração (%)
                                *</label>
                            <div *ngIf="editForm.controls['parametroAlteracao']
                                            && !editForm.controls['parametroAlteracao'].valid
                                            && (editForm.controls['parametroAlteracao'].touched
                                            || editForm.submitted)" class="ui-message ui-messages-error"
                                translate="Global.Mensagens.CampoObrigatorio">
                                Campo obrigatório.
                            </div>
                        </span>
                    </div>

                    <div class="ui-g-3 ui-md-3 ui-sm-3 form-fields-container">
                        <span class="md-inputfield">
                            <p-spinner required [min]="0" [max]="100" [step]="0.010" maxlength="5"
                                name="parametroExclusao" [(ngModel)]="manual.parametroExclusao">
                            </p-spinner>
                            <label for="parametroExclusao" translate="Cadastros.Manual.Exclusao(%)*">Exclusão (%)
                                *</label>
                            <div *ngIf="editForm.controls['parametroExclusao']
                                            && !editForm.controls['parametroExclusao'].valid
                                            && (editForm.controls['parametroExclusao'].touched
                                            || editForm.submitted)" class="ui-message ui-messages-error"
                                translate="Global.Mensagens.CampoObrigatorio">
                                Campo obrigatório.
                            </div>
                        </span>
                    </div>

                    <div class="ui-g-3 ui-md-3 ui-sm-3 form-fields-container">
                        <span class="md-inputfield">
                            <p-spinner required [min]="0" [max]="100" step="0.010" maxlength="5"
                                name="parametroConversao" [(ngModel)]="manual.parametroConversao">
                            </p-spinner>
                            <label translate="Cadastros.Manual.Conversao(%)*">Conversão (%) *</label>
                            <div *ngIf="editForm.controls['parametroConversao']
                                            && !editForm.controls['parametroConversao'].valid
                                            && (editForm.controls['parametroConversao'].touched
                                            || editForm.submitted)" class="ui-message ui-messages-error"
                                translate="Global.Mensagens.CampoObrigatorio">
                                Campo obrigatório.
                            </div>
                        </span>
                    </div>
                </div>

                <div class="ui-g-12 ui-md-12 ui-sm-12 form-fields-container">
                    <h2 translate="Cadastros.Manual.VersaoCPM">Versão do CPM</h2>

                    <div class="ui-g-2 ui-md-2 ui-sm-6">
                        <p-radioButton name="versaoCPM" label="4.2.1" [value]="421" [(ngModel)]="manual.versaoCPM">
                        </p-radioButton>
                    </div>

                    <div class="ui-g-2 ui-md-2 ui-sm-6">
                        <p-radioButton name="versaoCPM" label="4.3.1" [value]="431" [(ngModel)]="manual.versaoCPM">
                        </p-radioButton>
                    </div>

                </div>

                <div class="ui-g form-fields-container">
                    <div class="ui-g-12 ui-md-3 ui-md-offset-9">
                        <app-blue-button [buttonLabel]="'Cadastros.Manual.Botoes.NovoEsforcoFase' | translate"
                            buttonIcon="ui-icon-add" (click)="openDialogEsforcoFase()">
                        </app-blue-button>
                    </div>

                </div>

                <div class="dynamic-table-container">
                    <div class="table-container">
                        <p-dataTable [value]="manual.esforcoFases" [(selection)]="selectedEsforcoFase"
                            selectionMode="single" compareSelectionBy="equals">
                            <p-column [header]="'Cadastros.Manual.Fase' | translate" field="fase.nome">
                            </p-column>
                            <p-column [header]="'Cadastros.Manual.Percentual(%)' | translate" field="esforco">
                            </p-column>
                        </p-dataTable>
                    </div>

                    <div class="table-next-containter">
                        <div class="btn-table">
                            <button type="button" pButton class="green-btn side-button" name="edit" icon="ui-icon-edit"
                                value="edit" [title]="'Global.Botoes.Editar' | translate" (click)="editEsforcoFase()"
                                [disabled]="selectedEsforcoFase == null">
                            </button>
                            <button type="button" pButton class="ui-button-danger side-button" name="delete"
                                icon="ui-icon-trash" [title]="'Global.Botoes.Excluir' | translate"
                                (click)="deleteEsforcoFase()" [disabled]="selectedEsforcoFase == null">
                            </button>
                        </div>
                    </div>
                </div>

                <div class="ui-g">
                    <div class="ui-g-4 ui-g-offset-6">
                        <h4>
                            {{ 'Cadastros.Manual.Total:' | translate }} {{ getEsforcoEsforcoFasePercentual() }}
                        </h4>
                    </div>
                </div>

                <div class="ui-g form-fields-container">
                    <div class="ui-g-12 ui-md-3 ui-md-offset-9">
                        <app-blue-button [buttonLabel]="'Cadastros.Manual.Botoes.NovoDeflator' | translate"
                            buttonIcon="ui-icon-add" (click)="openDialogFatorAjuste()">
                        </app-blue-button>
                    </div>
                </div>

                <div class="dynamic-table-container">
                    <div class="table-container">
                        <p-dataTable [value]="manual.fatoresAjuste" [(selection)]="selectedFatorAjuste"
                            selectionMode="single" compareSelectionBy="equals">
                            <p-column [header]="'Cadastros.Manual.Codigo' | translate" field="codigo" [sortable]="true">
                                <ng-template let-col let-codigo="rowData" pTemplate="body">
                                    {{ codigo[col.field] == null ? '---' : codigo[col.field] }}
                                </ng-template>
                            </p-column>
                            <p-column [header]="'Cadastros.Manual.Nome' | translate" field="nome" [sortable]="true">
                            </p-column>
                            <p-column [header]="'Cadastros.Manual.Deflator' | translate" field="fator"
                                [sortable]="true">
                            </p-column>
                            <p-column [header]="'Cadastros.Manual.TipoDeflator' | translate" field="tipoAjuste"
                                [sortable]="true">
                                <ng-template let-col let-tipoAjuste="rowData" pTemplate="body">
                                    {{ tipoAjuste[col.field] == 'PERCENTUAL' ? ('Cadastros.Manual.Percentual' | translate) : ('Cadastros.Manual.Unitario' | translate) }}
                                </ng-template>
                            </p-column>
                            <p-column [header]="'Cadastros.Manual.Ativo' | translate" field="ativo" [sortable]="true">
                                <ng-template let-col let-ativo="rowData" pTemplate="body">
                                    {{ ativo[col.field] | activeBoolean }}
                                </ng-template>
                            </p-column>
                        </p-dataTable>
                    </div>

                    <div class="table-next-containter">
                        <div class="btn-table">
                            <button type="button" pButton class="green-btn side-button" name="edit" icon="ui-icon-edit"
                                value="edit" [title]="'Global.Botoes.Editar' | translate" (click)="editFatorAjuste()"
                                [disabled]="selectedFatorAjuste == null">
                            </button>
                            <button type="button" pButton class="ui-button-danger side-button" name="delete"
                                icon="ui-icon-trash" [title]="'Global.Botoes.Excluir' | translate"
                                (click)="deleteFatorAjuste()" [disabled]="selectedFatorAjuste == null">
                            </button>
                        </div>
                    </div>
                </div>

                <div class="ui-g ui-md-12 form-buttons-container">
                    <div class="ui-g-2 ui-md-2 ui-sm-12">
                        <app-white-button [buttonLabel]="'Global.Botoes.Cancelar' | translate" routerLink="/manual">
                        </app-white-button>
                    </div>
                    <div class="ui-g-2 ui-md-2 ui-sm-12">
                        <app-submit-button [buttonLabel]="'Global.Botoes.Salvar' | translate"
                            [disabled]="editForm.form.invalid || isSaving" (onclick)="save()">
                        </app-submit-button>
                    </div>
                </div>

            </form>

            <!-- Dialog Registro Esforco Fase -->
            <p-dialog [header]="'Cadastros.Manual.EsforcoFase' | translate" [(visible)]="showDialogEsforcoFase"
                [contentStyle]="{'overflow':'visible'}" [width]="800" name="esfocoFaseDialog">

                <form name="esforcoFaseForm" #esforcoFaseForm="ngForm">

                    <div class="ui-g-12 ui-md-12 ui-sm-12 form-fields-container">
                        <label for="faseDropdown" translate="Cadastros.Manual.Fase*">Tipo de Fase *</label>
                        <p-dropdown [filter]="true" [options]="fases" optionLabel="nome" [(ngModel)]="esforcoFase.fase"
                            [placeholder]="'Cadastros.Manual.Fase' | translate" [autoWidth]="false" name="faseDropdown">
                        </p-dropdown>
                        <div *ngIf="esforcoFaseForm.controls['esfocoFasePercent']
                                    && (!esforcoFaseForm.controls['faseDropdown'].valid
                                    && esforcoFaseForm.controls['faseDropdown'].touched)">
                            <span class="invalidField" translate="Global.Mensagens.CampoObrigatorio">Campo
                                obrigatório.</span>
                        </div>
                    </div>

                    <div class="ui-g-12 ui-md-12 ui-sm-12 form-fields-container">
                        <label for="esfocoFasePercent" translate="Cadastros.Manual.Esforco">Esforço (%) *</label>
                        <p-spinner required [step]="0.010" [min]="0" [max]="100" maxlength="5" name="esfocoFasePercent"
                            [(ngModel)]="esforcoFase.esforco">
                        </p-spinner>
                        <div *ngIf="esforcoFaseForm.controls['esfocoFasePercent']
                                    && (!esforcoFaseForm.controls['esfocoFasePercent'].valid
                                    && esforcoFaseForm.controls['esfocoFasePercent'].touched)">
                            <span class="invalidField" translate="Global.Mensagens.CampoObrigatorio">Campo
                                obrigatório.</span>
                        </div>
                    </div>

                    <div class="ui-g ui-md-12 form-buttons-container">
                        <div class="ui-g-2 ui-md-2 ui-sm-12">
                            <app-white-button [buttonLabel]="'Global.Botoes.Cancelar' | translate"
                                (click)="closeDialogEsforcoFase()">
                            </app-white-button>
                        </div>

                        <div class="ui-g-2 ui-md-2 ui-sm-12">
                            <app-green-button [buttonLabel]="'Global.Botoes.Salvar' | translate"
                                buttonIcon="ui-icon-add" (click)="addEsforcoFase(esforcoFaseForm)">
                            </app-green-button>
                        </div>
                    </div>

                </form>
            </p-dialog>

            <!-- Inicio Dialog Novo Deflator -->
            <p-dialog [header]="'Cadastros.Manual.Deflator' | translate" [(visible)]="showDialogFatorAjuste"
                [contentStyle]="{'overflow':'visible'}" [width]="800">

                <form name="deflatorForm" #deflatorForm="ngForm">

                    <div class="ui-g form-fields-container-modal">
                        <div class="ui-g-6 ui-md-6 ui-sm-12">
                            <label for="nomeFatorAjuste" translate="Cadastros.Manual.Nome*">Nome *</label>
                            <input type="text" pInputText name="nomeFatorAjuste" [(ngModel)]="fatorAjuste.nome" required
                                maxlength="255" />
                            <div *ngIf="deflatorForm.controls['nomeFatorAjuste']
                                    && (!deflatorForm.controls['nomeFatorAjuste'].valid
                                    && deflatorForm.controls['nomeFatorAjuste'].touched)">
                                <span class="invalidField" translate="Global.Mensagens.CampoObrigatorio">Campo
                                    obrigatório.</span>
                            </div>
                        </div>

                        <div class="ui-g-3 ui-md-3 ui-sm-12">
                            <label for="tipoAjusteDropdown" translate="Cadastros.CadastroDeflator.TipoDeflator*">Tipo
                                Deflator *</label><br>
                            <p-dropdown [filter]="true" [options]="tiposAjuste" name="tipoAjusteDropdown"
                                [(ngModel)]="fatorAjuste.tipoAjuste" filter="true" [autoWidth]="false"
                                [placeholder]="'Cadastros.Manual.TipoAjuste' | translate" required>
                            </p-dropdown>
                            <div *ngIf="deflatorForm.controls['tipoAjusteDropdown']
                                    && (!deflatorForm.controls['tipoAjusteDropdown'].valid
                                    && deflatorForm.controls['tipoAjusteDropdown'].touched)">
                                <span class="invalidField" translate="Global.Mensagens.CampoObrigatorio">Campo
                                    obrigatório.</span>
                            </div>
                        </div>

                        <div class="ui-g-3 ui-md-3 ui-sm-12">
                            <label *ngIf="isPercentualEnum(fatorAjuste.tipoAjuste)"
                                translate="Cadastros.Manual.Deflator(%)*">Deflator (%) *</label>
                            <label *ngIf="isUnitaryEnum(fatorAjuste.tipoAjuste)"
                                translate="Cadastros.Manual.Deflator(PF)*">Deflator (PF) *</label>
                            <label *ngIf="fatorAjuste.tipoAjuste === undefined"
                                translate="Cadastros.Manual.Deflator*">Deflator *</label>

                            <p-spinner maxlength="8" [min]="0" [max]="9999" name="fator" step="0.01"
                                [disabled]="habilitarDeflator()" required [(ngModel)]="fatorAjuste.fator">
                            </p-spinner>

                            <div *ngIf="deflatorForm.controls['fator']
                                        && (!deflatorForm.controls['fator'].valid
                                        && deflatorForm.controls['fator'].touched)">
                                <span class="invalidField" translate="Global.Mensagens.CampoObrigatorio">Campo
                                    obrigatório.</span>
                            </div>
                        </div>
                    </div>


                    <div class="ui-g-12 ui-md-12 ui-sm-12 form-fields-container-modal">
                        <label for="descricaoFatorAjuste" translate="Cadastros.Manual.Descricao">Descrição</label>
                        <textarea [rows]="10" [cols]="90" pInputTextarea maxlength="2000" name="descricaoFatorAjuste"
                            [(ngModel)]="fatorAjuste.descricao">
                            </textarea>
                    </div>

                    <div class="ui-g-5 ui-md-5 ui-sm-12 form-fields-container-modal" *ngIf="!isEditFatorAjuste">
                        <label for="codigo" translate="Cadastros.Manual.Codigo">Código</label>
                        <input type="text" name="codigo" [(ngModel)]="fatorAjuste.codigo" pInputText maxlength="255" />
                    </div>

                    <div class="ui-g-7 ui-md-7 ui-sm-12 form-fields-container-modal">
                        <label for="origem" translate="Cadastros.Manual.Origem">Origem</label>
                        <input type="text" name="origem" [(ngModel)]="fatorAjuste.origem" pInputText maxlength="255" />
                    </div>

                    <div class="ui-g ui-md-12 form-buttons-container">
                        <div class="ui-g-2 ui-md-2 ui-sm-12">
                            <app-white-button [buttonLabel]="'Global.Botoes.Cancelar' | translate"
                                (click)="closeDialogFatorAjuste()">
                            </app-white-button>
                        </div>

                        <div class="ui-g-2 ui-md-2 ui-sm-12">
                            <app-green-button [buttonLabel]="'Global.Botoes.Salvar' | translate"
                                buttonIcon="ui-icon-add" (click)="addFatorAjuste(deflatorForm)">
                            </app-green-button>
                        </div>
                    </div>

                </form>
            </p-dialog>
            <!-- Fim Dialog Novo Deflator -->

        </div>
    </div>
</div>

<p-confirmDialog [header]="'Global.Mensagens.Confirmacao' | translate" #dialog>
    <p-footer>
        <app-white-button [buttonLabel]="'Global.Botoes.Nao' | translate" buttonIcon="fa-close"
            (click)="dialog.reject()"></app-white-button>
        <app-green-button [buttonLabel]="'Global.Botoes.Sim' | translate" buttonIcon="fa-check"
            (click)="dialog.accept()"></app-green-button>
    </p-footer>
</p-confirmDialog>